stages: # List of stages for jobs, and their order of execution
  - test
  - deploy

test frontend and backend:
  resource_group: all
  image: node:20.17.0
  stage: test
  cache:
    key: frontend-cache
    paths:
      - frontend/node_modules
    key: backend-cache
    paths:
      - backend/node_modules
  script:
    - cd backend
    - npm install
    - npm run check
    - npm run test
    - cd ../frontend
    - npm install
    - npm run check
    - npm run test
    

test code-runner:
  resource_group: all
  image: rust:1.81
  stage: test
  # cache:
  #   key: code-runner-cache
  #   paths:
  #     - code-runner/target
  script:
    - cd code-runner
    - cargo build --verbose
    - cargo test --verbose

deploy:
  resource_group: all
  image: docker:27-dind-rootless
  stage: deploy

  rules:
  - if: '$CI_COMMIT_REF_NAME == "docker-stack"'
  - when: manual

  # cache:
  #   key: frontend-cache
  #   paths:
  #     - frontend/node_modules
  #   key: backend-cache
  #   paths:
  #     - backend/node_modules
  script:
    - unset DOCKER_HOST
    - docker compose build
